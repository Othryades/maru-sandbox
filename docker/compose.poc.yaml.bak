name: maru-poc

networks:
  linea:
    driver: bridge

services:
  initialization:
    image: busybox:latest
    container_name: init
    entrypoint: ["sh","/initialization/init.sh"]
    environment:
      CREATE_EMPTY_BLOCKS: "${CREATE_EMPTY_BLOCKS:-false}"
    volumes:
      - ./initialization/:/initialization:rw
    networks: [linea]

  besu:
    depends_on:
      initialization:
        condition: service_completed_successfully
    image: hyperledger/besu:25.8.0
    container_name: besu
    environment:
      LOG4J_CONFIGURATION_FILE: /var/lib/besu/log4j.xml
      JAVA_OPTS: -Xmx1g
    entrypoint:
      - /bin/bash
      - -c
      - >
        /opt/besu/bin/besu
        --config-file=/var/lib/besu/config.toml
        --genesis-file=/initialization/genesis-besu.json
        --node-private-key-file=/var/lib/besu/key
        --rpc-http-enabled=true
        --rpc-http-host=0.0.0.0
        --rpc-http-port=8545
        --host-allowlist=*
        --engine-rpc-enabled=true
        --engine-rpc-port=8550
        --engine-host-allowlist=*
        --engine-jwt-secret=/jwt/jwt.hex
        --p2p-port=30303
    volumes:
      - ./sequencer/config.toml:/var/lib/besu/config.toml:ro
      - ./sequencer/log4j.xml:/var/lib/besu/log4j.xml:ro
      - ./sequencer/key:/var/lib/besu/key:ro
      - ./initialization/:/initialization/:ro
      - ./jwt:/jwt:ro
    ports:
      - "8545:8545"     # JSON-RPC
      - "8550:8550"     # Engine API
      - "30303:30303"   # P2P (local)
    healthcheck:
      # Minimal JSON-RPC ping using /dev/tcp (no curl in image)
      test:
        [
          "CMD-SHELL",
          "bash -lc 'exec 3<>/dev/tcp/127.0.0.1/8545 && printf %s \"{\\\"jsonrpc\\\":\\\"2.0\\\",\\\"method\\\":\\\"web3_clientVersion\\\",\\\"params\\\":[],\\\"id\\\":1}\\n\" >&3 && read -t 3 line <&3 && echo \"$line\" | grep -q \"result\"'"
        ]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
    networks: [linea]

  maru:
    image: consensys/maru:${MARU_TAG:-0ad2e75}
    container_name: maru
    depends_on:
      besu:
        condition: service_healthy
    command:
      [
        "java",
        "-Dlog4j2.configurationFile=configs/log4j.xml",
        "-jar","maru.jar",
        "--maru-genesis-file","configs/genesis.json",
        "--config","configs/config.dev.toml"
      ]
    volumes:
      - ./maru/config.dev.toml:/opt/consensys/maru/configs/config.dev.toml:ro
      - ./maru/log4j.xml:/opt/consensys/maru/configs/log4j.xml:ro
      - ./initialization/genesis-maru.json:/opt/consensys/maru/configs/genesis.json:ro
      - ./maru/0x1b9abeec3215d8ade8a33607f2cf0f4f60e5f0d0.key:/tmp/maru-db/private-key
      - ./jwt:/opt/consensys/docker/jwt:ro   # maru expects jwt here
    ports:
      - "8080:8080"
    networks: [linea]