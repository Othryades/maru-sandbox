# SETUP COMPLET - Maru + Sequencer + Rollup-Boost
# Architecture: Client → Rollup-Boost → Sequencer ← Maru

name: maru-complete

networks:
  linea:
    driver: bridge
    ipam:
      config:
        - subnet: 11.11.11.0/24

services:
  initialization:
    image: busybox:latest
    container_name: init_complete
    environment:
      CREATE_EMPTY_BLOCKS: true
    entrypoint: [ "sh","/initialization/init.sh" ]
    volumes:
      - ./initialization/:/initialization:rw
    networks: [linea]

  sequencer:
    depends_on:
      initialization:
        condition: service_completed_successfully
    image: hyperledger/besu:25.8.0
    container_name: sequencer
    healthcheck:
      test: [ "CMD-SHELL", "bash -c \"[ -f /tmp/pid ]\"" ]
      interval: 1s
      timeout: 1s
      retries: 120
    environment:
      LOG4J_CONFIGURATION_FILE: /var/lib/besu/log4j.xml
      JAVA_OPTS: -Xmx512m -XX:+UnlockExperimentalVMOptions -XX:+UseZGC
    entrypoint:
      - /bin/bash
      - -c
      - |
        /opt/besu/bin/besu --config-file=/var/lib/besu/config.toml \
        --genesis-file=/initialization/genesis-besu.json \
        --node-private-key-file="/var/lib/besu/key" \
        --Xplugins-external-enabled=false
    volumes:
      - ./sequencer/config.toml:/var/lib/besu/config.toml:ro
      - ./sequencer/log4j.xml:/var/lib/besu/log4j.xml:ro
      - ./sequencer/key:/var/lib/besu/key:ro
      - ./initialization/:/initialization/:ro
    ports:
      - "8545:8545"     # JSON-RPC pour clients
      - "8550:8550"     # Engine API pour Maru
      - "30303:30303"   # P2P
    networks:
      linea:
        ipv4_address: 11.11.11.101

  rollup-boost:
    image: flashbots/rollup-boost:latest
    container_name: rollup-boost
    depends_on:
      sequencer:
        condition: service_healthy
    command:
      - --l2-url=http://sequencer:8545  # JSON-RPC du sequencer (pas de JWT)
      - --builder-url=http://sequencer:8545
      - --rpc-host=0.0.0.0
      - --rpc-port=8551
      - --log-level=debug
    ports:
      - "8551:8551"     # Rollup-Boost proxy pour clients
    networks: [linea]

  maru:
    image: consensys/maru:9839958
    container_name: maru
    depends_on:
      - sequencer
    command: [ 'java', '-Dlog4j2.configurationFile=configs/log4j.xml', '-jar', "maru.jar", '--maru-genesis-file', 'configs/genesis.json', '--config', 'configs/config.dev.toml']
    volumes:
      - ./maru/config.dev.toml:/opt/consensys/maru/configs/config.dev.toml:ro
      - ./maru/log4j.xml:/opt/consensys/maru/configs/log4j.xml:ro
      - ./initialization/genesis-maru.json:/opt/consensys/maru/configs/genesis.json:ro
      - ./maru/0x1b9abeec3215d8ade8a33607f2cf0f4f60e5f0d0.key:/tmp/maru-db/private-key
    ports:
      - "8080:8080"
    networks: [linea]
